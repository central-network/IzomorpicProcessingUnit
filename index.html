<meta charset="utf8" />
<script type="module">
    // const blob   = new Blob([`onmessage = e => WebAssembly.instantiate(...e.data).then(close);`]);
    WebAssembly.instantiateStreaming(fetch("mem.wasm"), self).then(async m => {

        const module = await WebAssembly.compileStreaming(fetch("cpu.wasm"));
        const blob   = new Blob([`onmessage = e => { e.data[1].push(console); WebAssembly.instantiate(...e.data).then(close); }`]);
        const url    = URL.createObjectURL(blob);

        const { memory, unlock, calc, exit, maxLength, resize, malloc, Float32Array } = m.instance.exports;
        const data = [module, [{memory}]];

        new Worker(url).postMessage(data);
        new Worker(url).postMessage(data);
        new Worker(url).postMessage(data);

        self.e = m.instance.exports;

        console.warn(m.instance.exports);
        
    })
</script>